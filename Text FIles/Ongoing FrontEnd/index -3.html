<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ticket Management System</title>
    <!-- Inter Font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Basic Reset and Font */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
            background: linear-gradient(to bottom, #e3f2fd, #ffffff); /* Light blue to white gradient */
            color: #333;
            line-height: 1.6;
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex;
            flex-direction: column;
            padding-top: 90px; /* Add padding to body to account for fixed header */
        }

        /* Container for main content */
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            flex-grow: 1; /* Allow container to grow and push footer down */
        }

        /* Header Styling */
        .header {
            text-align: center;
            background: #1976d2; /* Darker blue for header */
            color: white;
            padding: 15px 20px; /* Slightly smaller padding */
            border-radius: 0 0 12px 12px; /* Rounded bottom corners */
            margin-bottom: 0; /* No margin-bottom as it's fixed */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: fixed; /* Make header stable */
            top: 0;
            left: 0;
            width: 100%;
            z-index: 100; /* Ensure header is on top */
            display: flex; /* Use flexbox for header content */
            justify-content: space-between; /* Space out title and user info */
            align-items: center;
        }

        .header h1 {
            font-size: 2.2em; /* Slightly smaller font size */
            margin-bottom: 0; /* Remove margin-bottom */
            display: flex;
            align-items: center;
            gap: 10px; /* Space between icon and text */
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1em;
            font-weight: 500;
        }

        .header .user-info .logout-btn {
            background: rgba(255, 255, 255, 0.2); /* Semi-transparent white */
            border: 1px solid rgba(255, 255, 255, 0.5);
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            font-size: 0.9em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .header .user-info .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        h2 {
            font-size: 1.8em;
            color: #1976d2;
            margin-bottom: 20px;
            text-align: center;
        }

        h3 {
            font-size: 1.4em;
            color: #333;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            display: flex; /* Use flex for icon alignment */
            align-items: center;
            gap: 8px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
            margin-bottom: 20px;
            gap: 10px;
            justify-content: center; /* Center tabs */
        }

        .nav-tab {
            flex: 1;
            min-width: 120px; /* Minimum width for tabs */
            padding: 12px 15px;
            background: #bbdefb; /* Light blue */
            border: none;
            cursor: pointer;
            text-align: center;
            border-radius: 10px;
            transition: background 0.3s ease, transform 0.2s ease;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: #90caf9; /* Slightly darker light blue on hover */
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: #1976d2; /* Darker blue for active tab */
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(0); /* Reset transform for active tab */
        }

        /* Tab Content Styling */
        .tab-content {
            display: none;
            background: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #555;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"], /* Added for date input */
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Inter', sans-serif; /* Ensure font is applied */
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Buttons */
        button {
            background: #1976d2; /* Primary blue for general buttons */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-size: 1em;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: inline-flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: #1565c0; /* Slightly darker blue on hover */
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Specific button adjustments */
        .btn-red {
            background: #d32f2f; /* Red for delete/danger actions */
        }
        .btn-red:hover {
            background: #b71c1c;
        }
        .btn-orange {
            background: #ff9800; /* Orange for update actions */
        }
        .btn-orange:hover {
            background: #fb8c00;
        }
        .btn-green {
            background: #4caf50; /* Green for acknowledge/success actions */
        }
        .btn-green:hover {
            background: #388e3c;
        }
        .btn-purple {
            background: #9c27b0; /* Purple for edit actions */
        }
        .btn-purple:hover {
            background: #7b1fa2;
        }
        .btn-gray {
            background: #607d8b; /* Gray for general secondary actions */
        }
        .btn-gray:hover {
            background: #455a64;
        }

        /* List Styling (General for Engineers/Customers) */
        .list-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px dashed #eee;
        }

        .list-item {
            background: #f8f8f8; /* Lighter grey background for engineers/customers */
            padding: 15px; /* More padding for better look */
            margin-bottom: 12px; /* Consistent margin */
            border-radius: 8px; /* Rounded corners */
            border: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column; /* Stack content and actions */
            justify-content: space-between;
            align-items: flex-start; /* Align content to left */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            position: relative; /* For positioning actions */
        }

        .list-item:last-child {
            margin-bottom: 0;
        }

        .list-item-content {
            flex-grow: 1; /* Allow content to take space */
            width: 100%; /* Ensure content takes full width */
            margin-bottom: 10px; /* Space between content and actions */
        }

        .list-item-actions {
            display: flex;
            flex-direction: row; /* Horizontal alignment for buttons */
            gap: 10px; /* Gap between buttons */
            justify-content: flex-end; /* Align buttons to the right */
            width: 100%; /* Ensure actions take full width to push to right */
        }
        .list-item-actions button {
            padding: 8px 15px;
            font-size: 0.9em;
            margin-left: 0 !important; /* Override previous margin */
            width: auto; /* Allow buttons to size naturally */
            min-width: 80px; /* Ensure a minimum width for consistency */
            text-align: center;
        }

        /* Specific styling for ticket list items */
        .ticket-item {
            background: #e3f2fd; /* Light blue background */
            border-left: 5px solid #1976d2; /* Blue left border */
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative; /* Needed for absolute positioning of header elements */
            padding-top: 45px; /* Added padding to make space for absolute positioned ID and Status */
        }

        .ticket-item-header {
            display: flex;
            justify-content: space-between; /* Space out ID and Status */
            align-items: center;
            font-weight: bold;
            color: #1976d2;
            position: absolute; /* Position header elements absolutely within ticket-item */
            top: 15px;
            left: 15px;
            right: 15px;
        }

        .ticket-item-id {
            font-size: 1em;
            color: #1976d2;
        }

        .ticket-item-description {
            font-size: 1.1em;
            color: #333;
            text-align: left; /* Ensure left alignment */
            flex-grow: 1; /* Allow description to take available space */
            margin-bottom: 10px; /* Space between description and details */
            width: 100%; /* Ensure it takes full width */
        }

        .ticket-item-details {
            font-size: 0.9em;
            color: #666;
            margin-top: auto; /* Push details to the bottom */
            text-align: left; /* Ensure left alignment */
            margin-bottom: 5px; /* Space from buttons below */
            width: 100%; /* Ensure it takes full width */
        }

        .ticket-item-status {
            padding: 4px 8px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            display: inline-flex; /* For icon alignment */
            align-items: center;
            gap: 5px;
        }

        .status-CREATED { background-color: #2196F3; } /* Blue */
        .status-ACKNOWLEDGED { background-color: #FFC107; } /* Amber */
        .status-IN_PROGRESS { background-color: #00BCD4; } /* Cyan */
        .status-CLOSED { background-color: #795548; } /* Brown */


        /* Utility Classes */
        .hidden {
            display: none !important; /* Use !important to override other display properties */
        }

        hr {
            border: 0;
            height: 1px;
            background: #eee;
            margin: 30px 0;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200; /* Higher z-index than header */
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
            max-height: 80vh; /* Limit height for scrollable content */
            overflow-y: auto; /* Enable scrolling for tall modals */
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0; /* Override h3 margin */
            border-bottom: none; /* Override h3 border */
            padding-bottom: 0; /* Override h3 padding */
            color: #1976d2;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
            padding: 5px; /* Add padding for easier clicking */
        }

        .modal-close-btn:hover {
            color: #333;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .modal-actions button {
            margin-left: 0; /* Override general button margin */
        }

        /* Message Box Styling */
        #message-box {
            position: fixed;
            top: 100px; /* Adjusted to be below the fixed header */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1000; /* Ensure it's on top */
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: fadeOut 3s forwards;
            opacity: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            80% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding-top: 80px; /* Adjust padding for smaller header on mobile */
            }
            .header {
                padding: 10px 15px; /* Smaller padding for mobile header */
            }
            .header h1 {
                font-size: 1.8em;
            }
            .header .user-info {
                font-size: 0.9em;
                gap: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                width: 100%;
                margin-bottom: 10px;
            }

            .container {
                padding: 15px;
            }

            h2 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1.2em;
            }

            .list-item-actions {
                flex-direction: column; /* Stack buttons on small screens */
                align-items: flex-end; /* Align buttons to the right */
                gap: 5px; /* Smaller gap between stacked buttons */
            }
            .list-item-actions button {
                width: auto; /* Allow buttons to size naturally */
                min-width: unset; /* Remove min-width constraint */
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header .user-info {
                flex-direction: column;
                align-items: flex-end;
                gap: 5px;
            }
            .header .user-info .logout-btn {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .tab-content {
                padding: 20px;
            }

            button {
                width: 100%;
                margin-top: 10px;
            }

            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .list-item-actions {
                margin-top: 10px;
                width: 100%;
                display: flex;
                justify-content: flex-end;
            }

            .list-item-actions button {
                margin-left: 0;
                margin-top: 5px;
            }

            .ticket-item {
                padding: 10px;
                padding-top: 40px; /* Adjust padding for smaller header */
            }
            .ticket-item-header {
                top: 10px;
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
<div class="header">
    <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ticket">
            <path d="M2 9a3 3 0 0 1 0 6v-6Z"/><path d="M22 9a3 3 0 0 0 0 6v-6Z"/><path d="M18 12H6"/><path d="M4 12V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><path d="M4 12v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/>
        </svg>
        Ticket Management System
    </h1>
    <div class="user-info" id="headerUserInfo">
        <span>Logged in as: <b id="currentUser"></b> (<b id="currentRole"></b>)</span>
        <button class="logout-btn" onclick="logout()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="17 16 22 12 17 8"/><line x1="22" x2="10" y1="12" y2="12"/>
            </svg>
            Logout
        </button>
    </div>
</div>

<div class="container">
    <div id="loginSection">
        <h2>Login</h2>
        <form id="loginForm">
            <div class="form-group">
                <label for="loginUsername">Username:</label>
                <input type="text" id="loginUsername" required />
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" required />
            </div>
            <button type="submit" id="loginSubmitBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/>
                </svg>
                Login
            </button>
        </form>
    </div>

    <div id="mainApp" class="hidden">
        <div class="nav-tabs">
            <button class="nav-tab" id="tabEngineers" onclick="showTab('engineers')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.74v.44a2 2 0 0 1-2 2v.18a2 2 0 0 0-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.78 1.28a2 2 0 0 0 .73 2.73l.15.08a2 2 0 0 1 1 1.74v.44a2 2 0 0 0 2 2v.18a2 2 0 0 1 1 1.73l.43.25a2 2 0 0 1 2 0l.15-.08a2 2 0 0 0 2.73.73l.78 1.28a2 2 0 0 0-.73 2.73l-.15.08a2 2 0 0 1-1-1.74v-.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.78-1.28a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.44a2 2 0 0 0-2-2v-.18a2 2 0 0 1-1-1.73l-.43-.25a2 2 0 0 1-2 0l-.15.08a2 2 0 0 0-2.73-.73L12.22 2z"/><circle cx="12" cy="12" r="3"/>
                </svg>
                Engineers
            </button>
            <button class="nav-tab" id="tabCustomers" onclick="showTab('customers')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Customers
            </button>
            <button class="nav-tab active" id="tabTickets" onclick="showTab('tickets')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ticket">
                    <path d="M2 9a3 3 0 0 1 0 6v-6Z"/><path d="M22 9a3 3 0 0 0 0 6v-6Z"/><path d="M18 12H6"/><path d="M4 12V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"/><path d="M4 12v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/>
                </svg>
                Tickets
            </button>
        </div>

        <div id="engineers" class="tab-content">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
                Create Engineer
            </h3>
            <form id="engineerForm">
                <div class="form-group">
                    <label for="engineerUsername">Username:</label>
                    <input type="text" id="engineerUsername" required />
                </div>
                <div class="form-group">
                    <label for="engineerPassword">Password:</label>
                    <input type="password" id="engineerPassword" required />
                </div>
                <button type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M12 5v14"/><path d="M5 12h14"/>
                    </svg>
                    Create Engineer
                </button>
            </form>
            <hr>
            <h3 class="list-section">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Engineers List
            </h3>
            <div id="engineersList"></div>
        </div>

        <div id="customers" class="tab-content">
            <h3>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user-plus">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/>
                </svg>
                Create Customer
            </h3>
            <form id="customerForm">
                <div class="form-group">
                    <label for="customerUsername">Username:</label>
                    <input type="text" id="customerUsername" required />
                </div>
                <div class="form-group">
                    <label for="customerPassword">Password:</label>
                    <input type="password" id="customerPassword" required />
                </div>
                <button type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M12 5v14"/><path d="M5 12h14"/>
                    </svg>
                    Create Customer
                </button>
            </form>
            <hr>
            <h3 class="list-section">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Customers List
            </h3>
            <div id="customersList"></div>
        </div>

        <div id="tickets" class="tab-content active">
            <!-- Conditional rendering for Create Ticket section -->
            <div id="createTicketSection">
                <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-plus">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" x2="12" y1="18" y2="12"/><line x1="9" x2="15" y1="15" y2="15"/>
                    </svg>
                    Create Ticket
                </h3>
                <form id="ticketForm">
                    <div class="form-group">
                        <label for="ticketDescription">Description:</label>
                        <textarea id="ticketDescription" required></textarea>
                    </div>
                    <!-- Engineer dropdown for tickets, only visible to Engineers -->
                    <div id="ticketEngineerGroup" class="form-group hidden">
                        <label for="ticketEngineer">Engineer (Optional):</label>
                        <select id="ticketEngineer">
                            <option value="">Select Engineer</option>
                        </select>
                    </div>
                    <button type="submit">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                            <path d="M12 5v14"/><path d="M5 12h14"/>
                        </svg>
                        Create Ticket
                    </button>
                </form>
                <hr>
            </div>

            <h3 class="list-section">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-todo">
                    <rect x="3" y="5" width="6" height="6" rx="1"/><path d="m3 17h.01"/><path d="M13 17h.01"/><path d="M17 17h.01"/><path d="M13 5h8"/><path d="M13 9h8"/>
                </svg>
                Tickets List
            </h3>
            <div id="ticketsList"></div>
        </div>
    </div>
</div>

<script>
    // Base URL for the backend API. Ensure your Spring Boot app is running on this port.
    const API_BASE_URL = 'http://localhost:9090';

    // Global variables to store current user and their role after successful login
    let currentUser = null;
    let currentRole = null;
    let currentModal = null; // To keep track of the currently open modal

    // --- DOM Element References ---
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const loginUsernameInput = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginSubmitBtn = document.getElementById('loginSubmitBtn'); // Reference for login button
    const headerUserInfo = document.getElementById('headerUserInfo'); // Reference to the user info div in header
    const currentUserSpan = document.getElementById('currentUser');
    const currentRoleSpan = document.getElementById('currentRole');
    const tabEngineersBtn = document.getElementById('tabEngineers');
    const tabCustomersBtn = document.getElementById('tabCustomers');
    const tabTicketsBtn = document.getElementById('tabTickets');
    const engineerForm = document.getElementById('engineerForm');
    const engineerUsernameInput = document.getElementById('engineerUsername');
    const engineerPasswordInput = document.getElementById('engineerPassword');
    const engineersListDiv = document.getElementById('engineersList');
    const customerForm = document.getElementById('customerForm');
    const customerUsernameInput = document.getElementById('customerUsername');
    const customerPasswordInput = document.getElementById('customerPassword');
    const customersListDiv = document.getElementById('customersList');
    const ticketForm = document.getElementById('ticketForm');
    const ticketDescriptionInput = document.getElementById('ticketDescription');
    const ticketEngineerSelect = document.getElementById('ticketEngineer');
    const ticketsListDiv = document.getElementById('ticketsList');
    const ticketEngineerGroup = document.getElementById('ticketEngineerGroup'); // Reference for the engineer dropdown group
    const createTicketSection = document.getElementById('createTicketSection'); // Reference for the entire create ticket section

    // --- Utility Function: Display Message (instead of alert) ---
    function showMessage(message, type = 'info') {
        const existingMessageBox = document.getElementById('message-box');
        if (existingMessageBox) {
            existingMessageBox.remove(); // Remove any existing message box
        }

        const messageBox = document.createElement('div');
        messageBox.id = 'message-box';
        messageBox.innerHTML = `
                ${type === 'success' ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-circle"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>' : ''}
                ${type === 'error' ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-circle"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>' : ''}
                ${type === 'info' ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>' : ''}
                <span>${message}</span>
            `;

        if (type === 'success') {
            messageBox.style.backgroundColor = '#4CAF50';
            messageBox.style.color = 'white';
        } else if (type === 'error') {
            messageBox.style.backgroundColor = '#F44336';
            messageBox.style.color = 'white';
        } else { // info
            messageBox.style.backgroundColor = '#2196F3';
            messageBox.style.color = 'white';
        }
        document.body.appendChild(messageBox);
        lucide.createIcons(); // Initialize icons in the message box

        setTimeout(() => {
            messageBox.remove();
        }, 3000); // Remove after 3 seconds
    }

    // --- Custom Confirmation Modal ---
    function showConfirm(message, onConfirm) {
        closeModal(); // Close any existing modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Confirmation</h3>
                        <button class="modal-close-btn" onclick="closeModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                    <p>${message}</p>
                    <div class="modal-actions">
                        <button id="confirmYesBtn" class="btn-green">Yes</button>
                        <button id="confirmNoBtn" class="btn-red">No</button>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        currentModal = modal;
        lucide.createIcons();

        document.getElementById('confirmYesBtn').onclick = () => {
            onConfirm();
            closeModal();
        };
        document.getElementById('confirmNoBtn').onclick = () => {
            closeModal();
        };
    }

    // --- Generic Fetch Wrapper ---
    async function fetchData(url, options = {}) {
        try {
            const defaultHeaders = {
                'Content-Type': 'application/json',
            };

            // Add X-Username and X-User-Role headers if logged in
            if (currentUser && currentRole) {
                defaultHeaders['X-Username'] = currentUser;
                defaultHeaders['X-User-Role'] = currentRole;
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers,
                },
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Something went wrong.' }));
                throw new Error(errorData.error || `HTTP error! Status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('Fetch error:', error);
            throw error; // Re-throw to be caught by the calling function
        }
    }

    // --- LLM Integration Functions ---

    /**
     * Calls the Gemini API to generate a draft response for a ticket.
     * @param {object} ticket - The ticket object.
     * @returns {Promise<string>} - The generated draft response.
     */
    async function draftTicketResponse(ticket) {
        const prompt = `You are a helpful customer support engineer. Based on the following ticket details, draft a professional and helpful response or suggest resolution steps. Keep it concise, professional, and actionable.

Ticket ID: ${ticket.id}
Ticket Description: ${ticket.description}
Customer Comment: ${ticket.customerCommentOnTicket || 'N/A'}
Engineer Internal Notes (if any): ${ticket.engineerCommentOnTicket || 'N/A'}

Draft a response or resolution steps:`;

        try {
            const apiKey = ""; // Canvas will automatically provide the API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("No valid response from Gemini API.");
            }
        } catch (error) {
            console.error("Gemini API error (Draft Response):", error);
            showMessage(`Failed to draft response: ${error.message}`, 'error');
            return "Failed to generate a draft response.";
        }
    }

    /**
     * Calls the Gemini API to summarize a ticket.
     * @param {object} ticket - The ticket object.
     * @returns {Promise<string>} - The generated summary.
     */
    async function summarizeTicket(ticket) {
        const prompt = `Summarize the following support ticket in one concise paragraph. Focus on the core issue and any key customer details.

Ticket Description: ${ticket.description}
Customer Comment: ${ticket.customerCommentOnTicket || 'N/A'}

Summary:`;

        try {
            const apiKey = ""; // Canvas will automatically provide the API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error("No valid response from Gemini API.");
            }
        } catch (error) {
            console.error("Gemini API error (Summarize Ticket):", error);
            showMessage(`Failed to summarize ticket: ${error.message}`, 'error');
            return "Failed to generate a summary.";
        }
    }


    // --- Login Functionality ---
    loginForm.onsubmit = async function (e) {
        e.preventDefault(); // Prevent default form submission
        const username = loginUsernameInput.value;
        const password = loginPasswordInput.value;

        loginSubmitBtn.disabled = true;
        loginSubmitBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                    <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                </svg>
                Logging In...
            `;
        lucide.createIcons(); // Re-render icons for the loading state

        try {
            const data = await fetchData(`${API_BASE_URL}/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            currentUser = username;
            // Directly use data.role from backend response
            currentRole = data.role;

            // Hide login section and show main application
            loginSection.classList.add('hidden');
            mainApp.classList.remove('hidden');
            headerUserInfo.classList.remove('hidden'); // Show user info in header

            // Update user info in the header
            currentUserSpan.innerText = currentUser;
            currentRoleSpan.innerText = currentRole;

            // Adjust visibility of tabs and create ticket section based on role
            if (currentRole !== 'ENGINEER') {
                tabEngineersBtn.classList.add('hidden');
                tabCustomersBtn.classList.add('hidden');
                createTicketSection.classList.remove('hidden'); // Show create ticket section for customers
                ticketEngineerGroup.classList.add('hidden'); // Hide engineer dropdown for customers
                showTab('tickets'); // Default to tickets tab for customers
            } else {
                tabEngineersBtn.classList.remove('hidden');
                tabCustomersBtn.classList.remove('hidden');
                createTicketSection.classList.add('hidden'); // Hide create ticket section for engineers
                ticketEngineerGroup.classList.remove('hidden'); // Show engineer dropdown for engineers
                showTab('tickets'); // Default to tickets tab for engineers
            }

            // Load initial data for the respective lists
            loadEngineers();
            loadCustomers();
            loadTickets();
            showMessage(`Login successful as ${currentUser} (${currentRole})`, 'success');
        } catch (error) {
            showMessage(error.message || 'Login failed. Please check your credentials.', 'error');
        } finally {
            loginSubmitBtn.disabled = false;
            loginSubmitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/>
                    </svg>
                    Login
                `;
            lucide.createIcons();
        }
    };

    // --- Tab Switching Functionality ---
    function showTab(tabId) {
        // Remove 'active' class from all tab content divs
        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
        // Remove 'active' class from all navigation buttons
        document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

        // Add 'active' class to the selected tab content and button
        document.getElementById(tabId).classList.add('active');
        document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');

        // Adjust visibility of create ticket section and engineer dropdown based on role and active tab
        if (tabId === 'tickets') {
            if (currentRole === 'CUSTOMER') {
                createTicketSection.classList.remove('hidden');
                ticketEngineerGroup.classList.add('hidden');
            } else { // Engineer
                createTicketSection.classList.add('hidden');
                ticketEngineerGroup.classList.remove('hidden');
            }
            loadTickets();
        } else {
            createTicketSection.classList.add('hidden'); // Hide create ticket section on other tabs
            if (tabId === 'engineers') {
                loadEngineers();
            } else if (tabId === 'customers') {
                loadCustomers();
            }
        }
        lucide.createIcons(); // Re-render icons after tab switch
    }

    // --- Logout Functionality ---
    function logout() {
        currentUser = null;
        currentRole = null;
        closeModal(); // Close any open modals on logout
        // Reload the page to reset the application state
        location.reload();
    }

    // --- Create Engineer Functionality ---
    engineerForm.onsubmit = async function (e) {
        e.preventDefault();
        // Only allow engineers to create other engineers
        if (currentRole !== 'ENGINEER') {
            showMessage('Only engineers can create new engineer accounts.', 'error');
            return;
        }

        const username = engineerUsernameInput.value;
        const password = engineerPasswordInput.value; // Corrected: Now uses the password input

        const submitBtn = engineerForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                    <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                </svg>
                Creating...
            `;
        lucide.createIcons();

        try {
            await fetchData(`${API_BASE_URL}/engineers`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            showMessage('Engineer created successfully!', 'success');
            engineerForm.reset(); // Clear form fields
            loadEngineers(); // Reload the list of engineers
        } catch (error) {
            showMessage(error.message || 'Failed to create engineer.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M12 5v14"/><path d="M5 12h14"/>
                    </svg>
                    Create Engineer
                `;
            lucide.createIcons();
        }
    };

    // --- Create Customer Functionality ---
    customerForm.onsubmit = async function (e) {
        e.preventDefault();
        const username = customerUsernameInput.value;
        const password = customerPasswordInput.value;

        const submitBtn = customerForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                    <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                </svg>
                Creating...
            `;
        lucide.createIcons();

        try {
            await fetchData(`${API_BASE_URL}/customers`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });

            showMessage('Customer created successfully!', 'success');
            customerForm.reset(); // Clear form fields
            loadCustomers(); // Reload the list of customers
        } catch (error) {
            showMessage(error.message || 'Failed to create customer.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M12 5v14"/><path d="M5 12h14"/>
                    </svg>
                    Create Customer
                `;
            lucide.createIcons();
        }
    };

    // --- Create Ticket Functionality ---
    ticketForm.onsubmit = async function (e) {
        e.preventDefault();
        // Only allow customers to create tickets
        if (currentRole !== 'CUSTOMER') {
            showMessage('Only customers can create tickets.', 'error');
            return;
        }

        const description = ticketDescriptionInput.value;
        // For customers, engineerId will always be null as the dropdown is hidden
        const engineerId = currentRole === 'ENGINEER' && ticketEngineerSelect.value ? parseInt(ticketEngineerSelect.value) : null;

        const submitBtn = ticketForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                    <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                </svg>
                Creating...
            `;
        lucide.createIcons();

        try {
            await fetchData(`${API_BASE_URL}/tickets`, {
                method: 'POST',
                body: JSON.stringify({
                    description: description,
                    engineerId: engineerId // This will be null for customers
                })
            });

            showMessage('Ticket created successfully!', 'success');
            ticketForm.reset(); // Clear form fields
            loadTickets(); // Reload the list of tickets
        } catch (error) {
            showMessage(error.message || 'Failed to create ticket.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus">
                        <path d="M12 5v14"/><path d="M5 12h14"/>
                    </svg>
                    Create Ticket
                `;
            lucide.createIcons();
        }
    };

    // --- Load Data Functions ---

    // Load all engineers and populate the engineer selection dropdown for tickets
    async function loadEngineers() {
        try {
            const data = await fetchData(`${API_BASE_URL}/engineers`);

            // Clear existing list and dropdown options
            engineersListDiv.innerHTML = '';
            ticketEngineerSelect.innerHTML = '<option value="">Select Engineer</option>';

            if (data && data.length > 0) {
                data.forEach(e => {
                    // Populate engineers list
                    const engineerItem = document.createElement('div');
                    engineerItem.className = 'list-item'; /* Added list-item class for general styling */
                    engineerItem.innerHTML = `
                            <div class="list-item-content">
                                <span>${e.username} (ID: ${e.id})</span>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-orange" onclick="openUpdateUserModal('engineer', ${e.id}, '${e.username}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/>
                                    </svg>
                                    Update
                                </button>
                                <button class="btn-red" onclick="deleteUser('engineer', ${e.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        `;
                    engineersListDiv.appendChild(engineerItem);

                    // Populate engineer dropdown for ticket creation (only if current user is engineer)
                    if (currentRole === 'ENGINEER') {
                        const option = document.createElement('option');
                        option.value = e.id;
                        option.innerText = e.username;
                        ticketEngineerSelect.appendChild(option);
                    }
                });
            } else {
                engineersListDiv.innerHTML = '<p>No engineers found.</p>';
            }
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading engineers:', error);
            showMessage('Failed to load engineers. Network error or server issue.', 'error');
        }
    }

    // Load all customers
    async function loadCustomers() {
        try {
            const data = await fetchData(`${API_BASE_URL}/customers`);
            customersListDiv.innerHTML = ''; // Clear existing list
            if (data && data.length > 0) {
                data.forEach(c => {
                    const customerItem = document.createElement('div');
                    customerItem.className = 'list-item'; /* Added list-item class for general styling */
                    customerItem.innerHTML = `
                            <div class="list-item-content">
                                <span>${c.username} (ID: ${c.id})</span>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn-orange" onclick="openUpdateUserModal('customer', ${c.id}, '${c.username}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/>
                                    </svg>
                                    Update
                                </button>
                                <button class="btn-red" onclick="deleteUser('customer', ${c.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                        <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        `;
                    customersListDiv.appendChild(customerItem);
                });
            } else {
                customersListDiv.innerHTML = '<p>No customers found.</p>';
            }
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading customers:', error);
            showMessage('Failed to load customers. Network error or server issue.', 'error');
        }
    }

    // Load all tickets
    async function loadTickets() {
        try {
            const data = await fetchData(`${API_BASE_URL}/tickets`);
            ticketsListDiv.innerHTML = ''; // Clear existing list
            const filteredTickets = data.filter(t => {
                if (currentRole === 'CUSTOMER') {
                    // Ensure t.createdBy exists before accessing its properties
                    return t.createdBy && t.createdBy.username === currentUser;
                }
                return true; // Engineers see all tickets
            });

            if (filteredTickets && filteredTickets.length > 0) {
                filteredTickets.forEach(t => {
                    const ticketItem = document.createElement('div');
                    ticketItem.className = 'list-item ticket-item'; // Add ticket-item class for specific styling
                    ticketItem.innerHTML = `
                            <div class="ticket-item-header">
                                <span class="ticket-item-id">Ticket ID: ${t.id}</span>
                                <span class="ticket-item-status status-${t.status}">
                                    ${t.status === 'CREATED' ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-dot"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg>' : ''}
                                    ${t.status === 'ACKNOWLEDGED' ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-minus"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/></svg>' : ''}
                                    ${t.status === 'IN_PROGRESS' ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>' : ''}
                                    ${t.status === 'CLOSED' ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-x"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>' : ''}
                                    ${t.status.replace('_', ' ')}
                                </span>
                            </div>
                            <div class="ticket-item-description">${t.description}</div>
                            <div class="ticket-item-details">
                                ${t.createdBy ? `Created by: <b>${t.createdBy.username}</b>` : ''}
                                ${t.acknowledgedBy ? ` | Assigned to: <b>${t.acknowledgedBy.username}</b>` : ''}
                                ${t.ticketCreateDate ? ` | Created: ${new Date(t.ticketCreateDate).toLocaleDateString()}` : ''}
                                ${t.tentativeResolutionDate ? ` | Resolution Due: ${new Date(t.tentativeResolutionDate).toLocaleDateString()}` : ''}
                            </div>
                            <div class="list-item-actions">
                                ${currentRole === 'ENGINEER' && t.status === 'CREATED' ?
                        `<button class="btn-green" onclick="acknowledgeTicket(${t.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check">
                                            <path d="M20 6 9 17l-5-5"/>
                                        </svg>
                                        Acknowledge
                                    </button>` : ''
                    }
                                ${currentRole === 'ENGINEER' ? `
                                    <button class="btn-purple" onclick="openUpdateTicketModal(${t.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil">
                                            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/>
                                        </svg>
                                        Update
                                    </button>
                                    <button class="btn-red" onclick="deleteTicket(${t.id})">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                            <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/>
                                        </svg>
                                        Delete
                                    </button>
                                ` : ''}
                                <button class="btn-gray" onclick="openTicketDetailsModal(${t.id})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye">
                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    View Details
                                </button>
                            </div>
                        `;
                    ticketsListDiv.appendChild(ticketItem);
                });
            } else {
                ticketsListDiv.innerHTML = '<p>No tickets found.</p>';
            }
            lucide.createIcons();
        } catch (error) {
            console.error('Error loading tickets:', error);
            showMessage('Failed to load tickets. Network error or server issue.', 'error');
        }
    }

    // --- Acknowledge Ticket Functionality ---
    async function acknowledgeTicket(ticketId) {
        showConfirm('Are you sure you want to acknowledge this ticket?', async () => {
            try {
                await fetchData(`${API_BASE_URL}/tickets/${ticketId}/acknowledge`, {
                    method: 'PUT'
                });
                showMessage('Ticket acknowledged successfully!', 'success');
                loadTickets(); // Reload tickets to update status
            } catch (error) {
                showMessage(error.message || 'Failed to acknowledge ticket.', 'error');
            }
        });
    }

    // --- Delete User Functionality ---
    async function deleteUser(userType, id) {
        showConfirm(`Are you sure you want to delete this ${userType}?`, async () => {
            try {
                await fetchData(`${API_BASE_URL}/${userType}s/${id}`, {
                    method: 'DELETE'
                });
                showMessage(`${userType.charAt(0).toUpperCase() + userType.slice(1)} deleted successfully!`, 'success');
                if (userType === 'engineer') loadEngineers();
                else loadCustomers();
            } catch (error) {
                showMessage(error.message || `Failed to delete ${userType}.`, 'error');
            }
        });
    }

    // --- Delete Ticket Functionality ---
    async function deleteTicket(id) {
        showConfirm('Are you sure you want to delete this ticket?', async () => {
            try {
                await fetchData(`${API_BASE_URL}/tickets/${id}`, {
                    method: 'DELETE'
                });
                showMessage('Ticket deleted successfully!', 'success');
                loadTickets(); // Reload tickets
            } catch (error) {
                showMessage(error.message || 'Failed to delete ticket.', 'error');
            }
        });
    }

    // --- Open Update User Modal ---
    async function openUpdateUserModal(userType, id, username) {
        closeModal(); // Close any existing modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Update ${userType.charAt(0).toUpperCase() + userType.slice(1)}</h3>
                        <button class="modal-close-btn" onclick="closeModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                    <form id="updateUserForm">
                        <div class="form-group">
                            <label for="updateUsername">Username:</label>
                            <input type="text" id="updateUsername" value="${username}" required />
                        </div>
                        <div class="form-group">
                            <label for="updatePassword">Password (leave blank to keep current):</label>
                            <input type="password" id="updatePassword" />
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn-orange">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                                </svg>
                                Save Changes
                            </button>
                            <button type="button" class="btn-gray" onclick="closeModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
        document.body.appendChild(modal);
        currentModal = modal;
        lucide.createIcons();

        document.getElementById('updateUserForm').onsubmit = async function(e) {
            e.preventDefault();
            const newUsername = document.getElementById('updateUsername').value;
            const newPassword = document.getElementById('updatePassword').value;

            const updatePayload = { username: newUsername };
            if (newPassword) {
                updatePayload.password = newPassword;
            }

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                        <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                    </svg>
                    Saving...
                `;
            lucide.createIcons();

            try {
                await fetchData(`${API_BASE_URL}/${userType}s/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(updatePayload)
                });
                showMessage(`${userType.charAt(0).toUpperCase() + userType.slice(1)} updated successfully!`, 'success');
                closeModal();
                if (userType === 'engineer') loadEngineers();
                else loadCustomers();
            } catch (error) {
                showMessage(error.message || `Failed to update ${userType}.`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save Changes
                    `;
                lucide.createIcons();
            }
        };
    }

    // --- Open Update Ticket Modal ---
    async function openUpdateTicketModal(ticketId) {
        closeModal();
        try {
            const ticket = await fetchData(`${API_BASE_URL}/tickets/${ticketId}`);
            const engineers = await fetchData(`${API_BASE_URL}/engineers`);

            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Update Ticket #${ticket.id}</h3>
                            <button class="modal-close-btn" onclick="closeModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <form id="updateTicketForm">
                            <div class="form-group">
                                <label for="updateTicketDescription">Description:</label>
                                <textarea id="updateTicketDescription" rows="4" required>${ticket.description}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="updateTicketStatus">Status:</label>
                                <select id="updateTicketStatus" required>
                                    <option value="CREATED" ${ticket.status === 'CREATED' ? 'selected' : ''}>CREATED</option>
                                    <option value="ACKNOWLEDGED" ${ticket.status === 'ACKNOWLEDGED' ? 'selected' : ''}>ACKNOWLEDGED</option>
                                    <option value="IN_PROGRESS" ${ticket.status === 'IN_PROGRESS' ? 'selected' : ''}>IN_PROGRESS</option>
                                    <option value="CLOSED" ${ticket.status === 'CLOSED' ? 'selected' : ''}>CLOSED</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="updateTicketEngineer">Assign Engineer:</label>
                                <select id="updateTicketEngineer">
                                    <option value="">Unassigned</option>
                                    ${engineers.map(e => `<option value="${e.id}" ${ticket.acknowledgedBy && ticket.acknowledgedBy.id === e.id ? 'selected' : ''}>${e.username}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="updateTentativeResolutionDate">Tentative Resolution Date:</label>
                                <input type="date" id="updateTentativeResolutionDate" value="${ticket.tentativeResolutionDate || ''}" />
                            </div>
                            <div class="form-group">
                                <label for="updateCustomerComment">Customer Comment:</label>
                                <textarea id="updateCustomerComment" rows="2">${ticket.customerCommentOnTicket || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label for="updateEngineerComment">Engineer Comment:</label>
                                <textarea id="updateEngineerComment" rows="2">${ticket.engineerCommentOnTicket || ''}</textarea>
                            </div>
                            <div class="modal-actions">
                                <button type="submit" class="btn-orange">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                                    </svg>
                                    Save Changes
                                </button>
                                <button type="button" class="btn-gray" onclick="closeModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                `;
            document.body.appendChild(modal);
            currentModal = modal;
            lucide.createIcons();

            document.getElementById('updateTicketForm').onsubmit = async function(e) {
                e.preventDefault();
                const updatedTicket = {
                    description: document.getElementById('updateTicketDescription').value,
                    status: document.getElementById('updateTicketStatus').value,
                    engineerId: document.getElementById('updateTicketEngineer').value ? parseInt(document.getElementById('updateTicketEngineer').value) : null,
                    tentativeResolutionDate: document.getElementById('updateTentativeResolutionDate').value || null,
                    customerCommentOnTicket: document.getElementById('updateCustomerComment').value,
                    engineerCommentOnTicket: document.getElementById('updateEngineerComment').value
                };

                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin">
                            <path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/>
                        </svg>
                        Saving...
                    `;
                lucide.createIcons();

                try {
                    await fetchData(`${API_BASE_URL}/tickets/${ticketId}`, {
                        method: 'PUT',
                        body: JSON.stringify(updatedTicket)
                    });
                    showMessage('Ticket updated successfully!', 'success');
                    closeModal();
                    loadTickets();
                } catch (error) {
                    showMessage(error.message || 'Failed to update ticket.', 'error');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save Changes
                        `;
                    lucide.createIcons();
                }
            };

        } catch (error) {
            showMessage(error.message || 'Failed to load ticket for update.', 'error');
        }
    }

    // --- Open Ticket Details Modal ---
    async function openTicketDetailsModal(ticketId) {
        closeModal();
        try {
            const ticket = await fetchData(`${API_BASE_URL}/tickets/${ticketId}`);
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Ticket Details #${ticket.id}</h3>
                            <button class="modal-close-btn" onclick="closeModal()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <p>${ticket.description}</p>
                        </div>
                        <div class="form-group">
                            <label>Status:</label>
                            <span class="ticket-item-status status-${ticket.status}">${ticket.status.replace('_', ' ')}</span>
                        </div>
                        <div class="form-group">
                            <label>Created By:</label>
                            <p>${ticket.createdBy ? ticket.createdBy.username : 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Assigned To:</label>
                            <p>${ticket.acknowledgedBy ? ticket.acknowledgedBy.username : 'Unassigned'}</p>
                        </div>
                        <div class="form-group">
                            <label>Created Date:</label>
                            <p>${new Date(ticket.ticketCreateDate).toLocaleString()}</p>
                        </div>
                        <div class="form-group">
                            <label>Tentative Resolution Date:</label>
                            <p>${ticket.tentativeResolutionDate || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Customer Comment:</label>
                            <p>${ticket.customerCommentOnTicket || 'N/A'}</p>
                        </div>
                        <div class="form-group">
                            <label>Engineer Comment:</label>
                            <p>${ticket.engineerCommentOnTicket || 'N/A'}</p>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-gray" onclick="closeModal()">Close</button>
                            <button class="btn-green" id="summarizeTicketBtn">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles">
                                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                                </svg>
                                Summarize
                            </button>
                            ${currentRole === 'ENGINEER' ? `
                                <button class="btn-blue" id="draftResponseBtn">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-plus">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="8" y2="14"/><line x1="9" x2="15" y1="11" y2="11"/>
                                    </svg>
                                    Draft Response
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            document.body.appendChild(modal);
            currentModal = modal;
            lucide.createIcons();

            document.getElementById('summarizeTicketBtn').onclick = async () => {
                const btn = document.getElementById('summarizeTicketBtn');
                btn.disabled = true;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/></svg> Summarizing...`;
                const summary = await summarizeTicket(ticket);
                showMessage(`Summary: ${summary}`, 'info');
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucude-sparkles"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Summarize`;
                lucide.createIcons();
            };

            if (currentRole === 'ENGINEER') {
                document.getElementById('draftResponseBtn').onclick = async () => {
                    const btn = document.getElementById('draftResponseBtn');
                    btn.disabled = true;
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin"><path d="M12 2v4"/><path d="m16.2 7.8 2.9-2.9"/><path d="M22 12h-4"/><path d="m16.2 16.2 2.9 2.9"/><path d="M12 22v-4"/><path d="m7.8 16.2-2.9 2.9"/><path d="M2 12h4"/><path d="m7.8 7.8-2.9-2.9"/></svg> Drafting...`;
                    const draft = await draftTicketResponse(ticket);
                    showMessage(`Drafted Response: ${draft}`, 'info');
                    btn.disabled = false;
                    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-plus"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="8" y2="14"/><line x1="9" x2="15" y1="11" y2="11"/></svg> Draft Response`;
                    lucide.createIcons();
                };
            }

        } catch (error) {
            showMessage(error.message || 'Failed to load ticket details.', 'error');
        }
    }

    // --- Close Modal Function ---
    function closeModal() {
        if (currentModal) {
            currentModal.remove();
            currentModal = null;
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initially hide the main app and show login
        mainApp.classList.add('hidden');
        loginSection.classList.remove('hidden');
        headerUserInfo.classList.add('hidden'); // Ensure user info is hidden on initial load
        lucide.createIcons(); // Initialize icons on initial load
    });
</script>
</body>
</html>