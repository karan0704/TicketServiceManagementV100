<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ticket Management System</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* Basic Reset and Font */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
      background: linear-gradient(to bottom, #e3f2fd, #ffffff);
      color: #333;
      line-height: 1.6;
      min-height: 100vh; /* Ensure body takes full viewport height */
      display: flex;
      flex-direction: column;
      padding-top: 90px; /* Add padding to body to account for fixed header */
    }

    /* Container for main content */
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      flex-grow: 1; /* Allow container to grow and push footer down */
    }

    /* Header Styling */
    .header {
      text-align: center;
      background: #1976d2;
      color: white;
      padding: 15px 20px; /* Slightly smaller padding */
      border-radius: 0 0 12px 12px; /* Rounded bottom corners */
      margin-bottom: 0; /* No margin-bottom as it's fixed */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: fixed; /* Make header stable */
      top: 0;
      left: 0;
      width: 100%;
      z-index: 100; /* Ensure header is on top */
    }

    h1 {
      font-size: 2.2em; /* Slightly smaller font size */
      margin-bottom: 5px;
    }

    h2 {
      font-size: 1.8em;
      color: #1976d2;
      margin-bottom: 20px;
      text-align: center;
    }

    h3 {
      font-size: 1.4em;
      color: #333;
      margin-top: 20px;
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 5px;
    }

    /* Navigation Tabs */
    .nav-tabs {
      display: flex;
      flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
      margin-bottom: 20px;
      gap: 10px;
      justify-content: center; /* Center tabs */
    }

    .nav-tab {
      flex: 1;
      min-width: 120px; /* Minimum width for tabs */
      padding: 12px 15px;
      background: #bbdefb;
      border: none;
      cursor: pointer;
      text-align: center;
      border-radius: 10px;
      transition: background 0.3s ease, transform 0.2s ease;
      font-weight: bold;
      color: #333;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .nav-tab:hover {
      background: #90caf9;
      transform: translateY(-2px);
    }

    .nav-tab.active {
      background: #1976d2;
      color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transform: translateY(0); /* Reset transform for active tab */
    }

    /* Tab Content Styling */
    .tab-content {
      display: none;
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      margin-bottom: 20px;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #555;
    }

    input[type="text"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: #1976d2;
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2);
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Buttons */
    button {
      background: #1976d2;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      font-size: 1em;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background: #1565c0;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Specific button adjustments */
    #mainApp > div:first-child button {
      margin-left: 15px;
      background: #d32f2f; /* Red for logout */
    }

    #mainApp > div:first-child button:hover {
      background: #b71c1c;
    }

    /* List Styling (General for Engineers/Customers) */
    .list-section {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px dashed #eee;
    }

    .list-item {
      background: #f8f8f8; /* Lighter grey background for engineers/customers */
      padding: 15px; /* More padding for better look */
      margin-bottom: 12px; /* Consistent margin */
      border-radius: 8px; /* Rounded corners */
      border: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column; /* Stack content and actions */
      justify-content: space-between;
      align-items: flex-start; /* Align content to left */
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Subtle shadow */
      position: relative; /* For positioning actions */
    }

    .list-item:last-child {
      margin-bottom: 0;
    }

    .list-item-content {
        flex-grow: 1; /* Allow content to take space */
        width: 100%; /* Ensure content takes full width */
        margin-bottom: 10px; /* Space between content and actions */
    }

    .list-item-actions {
      display: flex;
      flex-direction: row; /* Horizontal alignment for buttons */
      gap: 10px; /* Gap between buttons */
      justify-content: flex-end; /* Align buttons to the right */
      width: 100%; /* Ensure actions take full width to push to right */
    }
    .list-item-actions button {
      padding: 8px 15px;
      font-size: 0.9em;
      margin-left: 0 !important; /* Override previous margin */
      width: auto; /* Allow buttons to size naturally */
      min-width: 80px; /* Ensure a minimum width for consistency */
      text-align: center;
    }

    .list-item-actions button.acknowledge-btn {
      background: #4caf50; /* Green for acknowledge */
    }

    .list-item-actions button.acknowledge-btn:hover {
      background: #388e3c;
    }

    .list-item-actions button.delete-btn {
      background: #f44336; /* Red for delete */
    }

    .list-item-actions button.delete-btn:hover {
      background: #d32f2f;
    }

    .list-item-actions button.update-btn {
      background: #ff9800; /* Orange for update */
    }

    .list-item-actions button.update-btn:hover {
      background: #fb8c00;
    }

    /* Specific styling for ticket list items */
    .ticket-item {
      background: #e3f2fd; /* Light blue background */
      border-left: 5px solid #1976d2; /* Blue left border */
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative; /* Needed for absolute positioning of status */
      padding-top: 45px; /* Added padding to make space for absolute positioned ID and Status */
    }

    .ticket-item-header {
      display: flex;
      justify-content: space-between; /* Space out ID and Status if they were inline */
      align-items: center;
      font-weight: bold;
      color: #1976d2;
      position: absolute; /* Position header elements absolutely within ticket-item */
      top: 15px;
      left: 15px;
      right: 15px;
    }

    .ticket-item-id {
      font-size: 1em;
      color: #1976d2;
      /* Position at top left - handled by parent .ticket-item-header */
    }

    .ticket-item-description {
      font-size: 1.1em;
      color: #333;
      text-align: left; /* Ensure left alignment */
      flex-grow: 1; /* Allow description to take available space */
      /* margin-top adjusted due to absolute positioning of header */
      margin-bottom: 10px; /* Space between description and details */
      width: 100%; /* Ensure it takes full width */
    }

    .ticket-item-details {
      font-size: 0.9em;
      color: #666;
      margin-top: auto; /* Push details to the bottom */
      text-align: left; /* Ensure left alignment */
      margin-bottom: 5px; /* Space from buttons below */
      width: 100%; /* Ensure it takes full width */
    }

    .ticket-item-status {
      padding: 4px 8px;
      border-radius: 5px;
      font-weight: bold;
      color: white;
      display: inline-block;
      /* Position at top right - handled by parent .ticket-item-header */
    }

    .status-CREATED { background-color: #2196F3; } /* Blue */
    .status-ACKNOWLEDGED { background-color: #FFC107; } /* Amber */
    .status-IN_PROGRESS { background-color: #00BCD4; } /* Cyan */
    .status-CLOSED { background-color: #795548; } /* Brown */


    /* Utility Classes */
    .hidden {
      display: none;
    }

    hr {
      border: 0;
      height: 1px;
      background: #eee;
      margin: 30px 0;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      body {
        padding-top: 80px; /* Adjust padding for smaller header on mobile */
      }
      .header {
        padding: 10px 15px; /* Smaller padding for mobile header */
      }
      h1 {
        font-size: 2em;
      }

      .nav-tabs {
        flex-direction: column;
      }

      .nav-tab {
        width: 100%;
        margin-bottom: 10px;
      }

      .container {
        padding: 15px;
      }

      h2 {
        font-size: 1.5em;
      }

      h3 {
        font-size: 1.2em;
      }

      .list-item-actions {
        flex-direction: row; /* Revert to row on very small screens if needed, or keep column */
        justify-content: flex-end; /* Align to right */
        flex-wrap: wrap; /* Allow wrapping */
      }
      .list-item-actions button {
        margin-top: 5px; /* Add margin top for wrapped buttons */
        margin-left: 5px; /* Add some horizontal margin */
        width: auto; /* Allow buttons to size naturally */
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 10px;
      }

      h1 {
        font-size: 1.8em;
      }

      .tab-content {
        padding: 20px;
      }

      button {
        width: 100%;
        margin-top: 10px;
      }

      .list-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .list-item-actions {
        margin-top: 10px;
        width: 100%;
        display: flex;
        justify-content: flex-end;
      }

      .list-item-actions button {
        margin-left: 0;
        margin-top: 5px;
      }

      .ticket-item {
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Ticket Management System</h1>
  </div>

  <div class="container">
    <div id="loginSection">
      <h2>Login</h2>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginUsername">Username:</label>
          <input type="text" id="loginUsername" required />
        </div>
        <div class="form-group">
          <label for="loginPassword">Password:</label>
          <input type="password" id="loginPassword" required />
        </div>
        <button type="submit">Login</button>
      </form>
    </div>

    <div id="mainApp" class="hidden">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: #e0f2f7; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <span style="font-family: 'Inter', sans-serif; font-size: 1.15em; font-weight: bold; color: #0d47a1;">
          Logged in as: <span id="currentUser"></span> (<span id="currentRole"></span>)
        </span>
        <button onclick="logout()">Logout</button>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab" id="tabEngineers" onclick="showTab('engineers')">Engineers</button>
        <button class="nav-tab" id="tabCustomers" onclick="showTab('customers')">Customers</button>
        <button class="nav-tab active" id="tabTickets" onclick="showTab('tickets')">Tickets</button>
      </div>

      <div id="engineers" class="tab-content">
        <h3>Create Engineer</h3>
        <form id="engineerForm">
          <div class="form-group">
            <label for="engineerUsername">Username:</label>
            <input type="text" id="engineerUsername" required />
          </div>
          <div class="form-group">
            <label for="engineerPassword">Password:</label>
            <input type="password" id="engineerPassword" required />
          </div>
          <button type="submit">Create Engineer</button>
        </form>
        <hr>
        <h3 class="list-section">Engineers List</h3>
        <div id="engineersList"></div>
      </div>

      <div id="customers" class="tab-content">
        <h3>Create Customer</h3>
        <form id="customerForm">
          <div class="form-group">
            <label for="customerUsername">Username:</label>
            <input type="text" id="customerUsername" required />
          </div>
          <div class="form-group">
            <label for="customerPassword">Password:</label>
            <input type="password" id="customerPassword" required />
          </div>
          <button type="submit">Create Customer</button>
        </form>
        <hr>
        <h3 class="list-section">Customers List</h3>
        <div id="customersList"></div>
      </div>

      <div id="tickets" class="tab-content active">
        <!-- Conditional rendering for Create Ticket section -->
        <div id="createTicketSection">
          <h3>Create Ticket</h3>
          <form id="ticketForm">
            <div class="form-group">
              <label for="ticketDescription">Description:</label>
              <textarea id="ticketDescription" required></textarea>
            </div>
            <!-- Engineer dropdown for tickets, only visible to Engineers -->
            <div id="ticketEngineerGroup" class="form-group">
              <label for="ticketEngineer">Engineer (Optional):</label>
              <select id="ticketEngineer">
                <option value="">Select Engineer</option>
              </select>
            </div>
            <button type="submit">Create Ticket</button>
          </form>
          <hr>
        </div>
        
        <h3 class="list-section">Tickets List</h3>
        <div id="ticketsList"></div>
      </div>
    </div>
  </div>

  <script>
    // Base URL for the backend API. Ensure your Spring Boot app is running on this port.
    const API_BASE_URL = 'http://localhost:9090';

    // Global variables to store current user and their role after successful login
    let currentUser = null;
    let currentRole = null;

    // --- DOM Element References ---
    const loginSection = document.getElementById('loginSection');
    const mainApp = document.getElementById('mainApp');
    const loginForm = document.getElementById('loginForm');
    const loginUsernameInput = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');
    const currentUserSpan = document.getElementById('currentUser');
    const currentRoleSpan = document.getElementById('currentRole');
    const tabEngineersBtn = document.getElementById('tabEngineers');
    const tabCustomersBtn = document.getElementById('tabCustomers');
    const tabTicketsBtn = document.getElementById('tabTickets');
    const engineerForm = document.getElementById('engineerForm');
    const engineerUsernameInput = document.getElementById('engineerUsername');
    const engineerPasswordInput = document.getElementById('engineerPassword');
    const engineersListDiv = document.getElementById('engineersList');
    const customerForm = document.getElementById('customerForm');
    const customerUsernameInput = document.getElementById('customerUsername');
    const customerPasswordInput = document.getElementById('customerPassword');
    const customersListDiv = document.getElementById('customersList');
    const ticketForm = document.getElementById('ticketForm');
    const ticketDescriptionInput = document.getElementById('ticketDescription');
    const ticketEngineerSelect = document.getElementById('ticketEngineer');
    const ticketsListDiv = document.getElementById('ticketsList');
    const ticketEngineerGroup = document.getElementById('ticketEngineerGroup'); // New reference for the engineer dropdown group
    const createTicketSection = document.getElementById('createTicketSection'); // New reference for the entire create ticket section

    // --- Utility Function: Display Message (instead of alert) ---
    function showMessage(message, type = 'info') {
        const messageBox = document.createElement('div');
        messageBox.style.cssText = `
            position: fixed;
            /* Position below header, assuming header height + padding + margin is around 120-150px */
            top: 100px; /* Adjusted top position to be just below the fixed header */
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            animation: fadeOut 3s forwards;
            opacity: 1;
        `;
        if (type === 'success') {
            messageBox.style.backgroundColor = '#4CAF50';
            messageBox.style.color = 'white';
        } else if (type === 'error') {
            messageBox.style.backgroundColor = '#F44336';
            messageBox.style.color = 'white';
        } else { // info
            messageBox.style.backgroundColor = '#2196F3';
            messageBox.style.color = 'white';
        }
        messageBox.innerText = message;
        document.body.appendChild(messageBox);

        // Define fadeOut animation
        const styleSheet = document.createElement('style');
        styleSheet.innerHTML = `
            @keyframes fadeOut {
                0% { opacity: 1; transform: translateX(-50%) translateY(0); }
                80% { opacity: 1; transform: translateX(-50%) translateY(0); }
                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            }
        `;
        document.head.appendChild(styleSheet);


        setTimeout(() => {
            messageBox.remove();
            styleSheet.remove();
        }, 3000); // Remove after 3 seconds
    }


    // --- Login Functionality ---
    loginForm.onsubmit = async function (e) {
      e.preventDefault(); // Prevent default form submission
      const username = loginUsernameInput.value;
      const password = loginPasswordInput.value;

      try {
        const res = await fetch(`${API_BASE_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await res.json(); // Parse the JSON response

        if (res.ok) { // Check if the HTTP status is 2xx (success)
          currentUser = username;
          // Determine role based on the message from the backend
          currentRole = data.message.includes('ENGINEER') ? 'ENGINEER' : 'CUSTOMER';

          // Hide login section and show main application
          loginSection.classList.add('hidden');
          mainApp.classList.remove('hidden');

          // Update user info in the header
          currentUserSpan.innerText = currentUser;
          currentRoleSpan.innerText = currentRole;

          // Hide Engineer and Customer tabs if the user is not an Engineer
          if (currentRole !== 'ENGINEER') {
            tabEngineersBtn.style.display = 'none';
            tabCustomersBtn.style.display = 'none';
            createTicketSection.classList.remove('hidden'); // Show create ticket section for customers
            ticketEngineerGroup.classList.add('hidden'); // Hide engineer dropdown for customers
          } else {
            // Ensure tabs are visible if an engineer logs in
            tabEngineersBtn.style.display = 'inline-block';
            tabCustomersBtn.style.display = 'inline-block';
            createTicketSection.classList.add('hidden'); // Hide create ticket section for engineers
            ticketEngineerGroup.classList.remove('hidden'); // Show engineer dropdown for engineers
          }

          // Load initial data for the respective lists
          loadEngineers();
          loadCustomers();
          loadTickets();
          showMessage(`Login successful as ${currentUser} (${currentRole})`, 'success');
        } else {
          // Display error message from the backend or a generic one
          showMessage(data.error || 'Login failed. Please check your credentials.', 'error');
        }
      } catch (error) {
        console.error('Error during login:', error);
        showMessage('Network error or server is unreachable. Please try again later.', 'error');
      }
    };

    // --- Tab Switching Functionality ---
    function showTab(tabId) {
      // Remove 'active' class from all tab content divs
      document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
      // Remove 'active' class from all navigation buttons
      document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));

      // Add 'active' class to the selected tab content and button
      document.getElementById(tabId).classList.add('active');
      document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');

      // Adjust visibility of create ticket section and engineer dropdown based on role and active tab
      if (tabId === 'tickets') {
        if (currentRole === 'CUSTOMER') {
            createTicketSection.classList.remove('hidden');
            ticketEngineerGroup.classList.add('hidden');
        } else { // Engineer
            createTicketSection.classList.add('hidden');
            ticketEngineerGroup.classList.remove('hidden');
        }
        loadTickets();
      } else {
        createTicketSection.classList.add('hidden'); // Hide create ticket section on other tabs
        if (tabId === 'engineers') {
          loadEngineers();
        } else if (tabId === 'customers') {
          loadCustomers();
        }
      }
    }

    // --- Logout Functionality ---
    function logout() {
      currentUser = null;
      currentRole = null;
      closeModal(); // Close any open modals on logout
      // Reload the page to reset the application state
      location.reload();
    }

    // --- Create Engineer Functionality ---
    engineerForm.onsubmit = async function (e) {
      e.preventDefault();
      // Only allow engineers to create other engineers
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can create new engineer accounts.', 'error');
        return;
      }

      const username = engineerUsernameInput.value;
      const password = engineerPasswordInput.value;

      try {
        const res = await fetch(`${API_BASE_URL}/engineers`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-Role': currentRole, // Send current user's role
            'X-Username': currentUser // Send current user's username
          },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          showMessage('Engineer created successfully!', 'success');
          engineerForm.reset(); // Clear form fields
          loadEngineers(); // Reload the list of engineers
        } else {
          const errorData = await res.json();
          showMessage(errorData.error || 'Failed to create engineer.', 'error');
        }
      } catch (error) {
        console.error('Error creating engineer:', error);
        showMessage('Network error or server is unreachable. Failed to create engineer.', 'error');
      }
    };

    // --- Create Customer Functionality ---
    customerForm.onsubmit = async function (e) {
      e.preventDefault();
      const username = customerUsernameInput.value;
      const password = customerPasswordInput.value;

      try {
        const res = await fetch(`${API_BASE_URL}/customers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        if (res.ok) {
          showMessage('Customer created successfully!', 'success');
          customerForm.reset(); // Clear form fields
          loadCustomers(); // Reload the list of customers
        } else {
          const errorData = await res.json();
          showMessage(errorData.error || 'Failed to create customer.', 'error');
        }
      } catch (error) {
        console.error('Error creating customer:', error);
        showMessage('Network error or server is unreachable. Failed to create customer.', 'error');
      }
    };

    // --- Create Ticket Functionality ---
    ticketForm.onsubmit = async function (e) {
      e.preventDefault();
      // Only allow customers to create tickets
      if (currentRole !== 'CUSTOMER') {
        showMessage('Only customers can create tickets.', 'error');
        return;
      }

      const description = ticketDescriptionInput.value;
      // For customers, engineerId will always be null as the dropdown is hidden
      const engineerId = currentRole === 'ENGINEER' && ticketEngineerSelect.value ? parseInt(ticketEngineerSelect.value) : null;

      try {
        const res = await fetch(`${API_BASE_URL}/tickets`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-User-Role': currentRole, // Send current user's role
            'X-Username': currentUser // Send current user's username
          },
          body: JSON.stringify({
            description: description,
            engineerId: engineerId // This will be null for customers
          })
        });

        if (res.ok) {
          showMessage('Ticket created successfully!', 'success');
          ticketForm.reset(); // Clear form fields
          loadTickets(); // Reload the list of tickets
        } else {
          const errorData = await res.json();
          showMessage(errorData.error || 'Failed to create ticket.', 'error');
        }
      } catch (error) {
        console.error('Error creating ticket:', error);
        showMessage('Network error or server is unreachable. Failed to create ticket.', 'error');
      }
    };

    // --- Load Data Functions ---

    // Load all engineers and populate the engineer selection dropdown for tickets
    async function loadEngineers() {
      try {
        const res = await fetch(`${API_BASE_URL}/engineers`);
        const data = await res.json();
        
        // Clear existing list and dropdown options
        engineersListDiv.innerHTML = '';
        ticketEngineerSelect.innerHTML = '<option value="">Select Engineer</option>';

        if (data && data.length > 0) {
          data.forEach(e => {
            // Populate engineers list
            const engineerItem = document.createElement('div');
            engineerItem.className = 'list-item'; /* Added list-item class for general styling */
            engineerItem.innerHTML = `
              <div class="list-item-content">
                <span>${e.username} (ID: ${e.id})</span>
              </div>
              <div class="list-item-actions">
                <button class="update-btn" onclick="openUpdateEngineerModal(${e.id}, '${e.username}', '${e.password}')">Update</button>
                <button class="delete-btn" onclick="deleteEngineer(${e.id})">Delete</button>
              </div>
            `;
            engineersListDiv.appendChild(engineerItem);

            // Populate engineer dropdown for ticket creation (only if current user is engineer)
            if (currentRole === 'ENGINEER') {
              const option = document.createElement('option');
              option.value = e.id;
              option.innerText = e.username;
              ticketEngineerSelect.appendChild(option);
            }
          });
        } else {
          engineersListDiv.innerHTML = '<p>No engineers found.</p>';
        }
      } catch (error) {
        console.error('Error loading engineers:', error);
        showMessage('Failed to load engineers. Network error or server issue.', 'error');
      }
    }

    // Load all customers
    async function loadCustomers() {
      try {
        const res = await fetch(`${API_BASE_URL}/customers`);
        const data = await res.json();
        customersListDiv.innerHTML = ''; // Clear existing list
        if (data && data.length > 0) {
          data.forEach(c => {
            const customerItem = document.createElement('div');
            customerItem.className = 'list-item'; /* Added list-item class for general styling */
            customerItem.innerHTML = `
              <div class="list-item-content">
                <span>${c.username} (ID: ${c.id})</span>
              </div>
              <div class="list-item-actions">
                <button class="update-btn" onclick="openUpdateCustomerModal(${c.id}, '${c.username}', '${c.password}')">Update</button>
                <button class="delete-btn" onclick="deleteCustomer(${c.id})">Delete</button>
              </div>
            `;
            customersListDiv.appendChild(customerItem);
          });
        } else {
          customersListDiv.innerHTML = '<p>No customers found.</p>';
        }
      } catch (error) {
        console.error('Error loading customers:', error);
        showMessage('Failed to load customers. Network error or server issue.', 'error');
      }
    }

    // Load all tickets
    async function loadTickets() {
      try {
        const res = await fetch(`${API_BASE_URL}/tickets`);
        const data = await res.json();
        ticketsListDiv.innerHTML = ''; // Clear existing list
        if (data && data.length > 0) {
          data.forEach(t => {
            const ticketItem = document.createElement('div');
            ticketItem.className = 'list-item ticket-item'; // Add ticket-item class for specific styling
            ticketItem.innerHTML = `
              <div class="ticket-item-header">
                <span class="ticket-item-id">Ticket ID: ${t.id}</span>
                <span class="ticket-item-status status-${t.status}">${t.status.replace('_', ' ')}</span>
              </div>
              <div class="ticket-item-description">${t.description}</div>
              <div class="ticket-item-details">
                ${t.createdBy ? `Created by: <b>${t.createdBy.username}</b>` : ''}
                ${t.acknowledgedBy ? ` | Assigned to: <b>${t.acknowledgedBy.username}</b>` : ''}
              </div>
              <div class="list-item-actions">
                ${currentRole === 'ENGINEER' && t.status === 'CREATED' ?
                  `<button class="acknowledge-btn" onclick="acknowledgeTicket(${t.id})">Acknowledge</button>` : ''
                }
                ${currentRole === 'ENGINEER' ? `
                  <button class="update-btn" onclick="openUpdateTicketModal(${t.id}, '${t.description}', '${t.status}', ${t.acknowledgedBy ? t.acknowledgedBy.id : 'null'})">Update</button>
                  <button class="delete-btn" onclick="deleteTicket(${t.id})">Delete</button>
                ` : ''}
              </div>
            `;
            ticketsListDiv.appendChild(ticketItem);
          });
        } else {
          ticketsListDiv.innerHTML = '<p>No tickets found.</p>';
        }
    } catch (error) {
        console.error('Error loading tickets:', error);
        showMessage('Failed to load tickets. Network error or server issue.', 'error');
    }
    }

    // --- Ticket Actions ---
    async function acknowledgeTicket(ticketId) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can acknowledge tickets.', 'error');
        return;
      }
      if (!currentUser) {
        showMessage('Please log in as an engineer to acknowledge tickets.', 'error');
        return;
      }

      // Find the current engineer's ID from the loaded engineers list
      let engineerId = null;
      try {
        const resEngineers = await fetch(`${API_BASE_URL}/engineers`);
        const engineersData = await resEngineers.json();
        const currentEngineer = engineersData.find(e => e.username === currentUser);
        if (currentEngineer) {
            engineerId = currentEngineer.id;
        } else {
            showMessage('Could not find current engineer\'s ID. Please ensure your engineer account exists.', 'error');
            return;
        }
      } catch (error) {
          console.error('Error fetching current engineer ID:', error);
          showMessage('Failed to get current engineer ID for acknowledgment.', 'error');
          return;
      }


      try {
        const res = await fetch(`${API_BASE_URL}/tickets/${ticketId}/acknowledge/${engineerId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-User-Role': currentRole,
            'X-Username': currentUser
          }
        });

        if (res.ok) {
          showMessage('Ticket acknowledged successfully!', 'success');
          loadTickets(); // Reload tickets to reflect changes
        } else {
          const errorData = await res.json();
          showMessage(errorData.error || 'Failed to acknowledge ticket.', 'error');
        }
      } catch (error) {
        console.error('Error acknowledging ticket:', error);
        showMessage('Network error or server is unreachable. Failed to acknowledge ticket.', 'error');
      }
    }

    async function deleteTicket(id) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can delete tickets.', 'error');
        return;
      }
      // Using a custom message box for confirmation instead of browser's confirm()
      showConfirmDialog('Are you sure you want to delete this ticket?', async () => {
        try {
          const res = await fetch(`${API_BASE_URL}/tickets/${id}`, {
            method: 'DELETE',
            headers: {
              'X-User-Role': currentRole,
              'X-Username': currentUser
            }
          });

          if (res.ok) {
            showMessage('Ticket deleted successfully!', 'success');
            loadTickets();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to delete ticket.', 'error');
          }
        } catch (error) {
          console.error('Error deleting ticket:', error);
          showMessage('Network error or server is unreachable. Failed to delete ticket.', 'error');
        }
      });
    }

    // --- Engineer Actions ---
    async function deleteEngineer(id) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can delete other engineers.', 'error');
        return;
      }
      showConfirmDialog('Are you sure you want to delete this engineer?', async () => {
        try {
          const res = await fetch(`${API_BASE_URL}/engineers/${id}`, {
            method: 'DELETE',
            headers: {
              'X-User-Role': currentRole,
              'X-Username': currentUser
            }
          });

          if (res.ok) {
            showMessage('Engineer deleted successfully!', 'success');
            loadEngineers();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to delete engineer.', 'error');
          }
        } catch (error) {
          console.error('Error deleting engineer:', error);
          showMessage('Network error or server is unreachable. Failed to delete engineer.', 'error');
        }
      });
    }

    // --- Customer Actions ---
    async function deleteCustomer(id) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can delete customers.', 'error');
        return;
      }
      showConfirmDialog('Are you sure you want to delete this customer?', async () => {
        try {
          const res = await fetch(`${API_BASE_URL}/customers/${id}`, {
            method: 'DELETE',
            headers: {
              'X-User-Role': currentRole,
              'X-Username': currentUser
            }
          });

          if (res.ok) {
            showMessage('Customer deleted successfully!', 'success');
            loadCustomers();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to delete customer.', 'error');
          }
        } catch (error) {
          console.error('Error deleting customer:', error);
          showMessage('Network error or server is unreachable. Failed to delete customer.', 'error');
        }
      });
    }

    // --- Modals for Update Operations ---
    // Generic modal structure
    const modalHtml = `
      <div id="genericModal" style="display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center;">
        <div style="background-color:#fefefe; margin: auto; padding:20px; border:1px solid #888; width:90%; max-width:500px; border-radius:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;">
          <span style="color:#aaa; position:absolute; top:10px; right:15px; font-size:28px; font-weight:bold; cursor:pointer;" onclick="closeModal()">&times;</span>
          <h2 id="modalTitle" style="text-align: left; margin-top: 0; margin-bottom: 20px; color: #1976d2;"></h2>
          <form id="modalForm">
            <!-- Form fields will be injected here -->
          </form>
          <div style="margin-top:20px; text-align:right;">
            <button type="button" onclick="closeModal()" style="background:#6c757d;">Cancel</button>
            <button type="submit" form="modalForm" style="margin-left:10px;">Save Changes</button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const genericModal = document.getElementById('genericModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalForm = document.getElementById('modalForm');

    function closeModal() {
      genericModal.style.display = 'none';
      modalForm.innerHTML = ''; // Clear form fields
      modalForm.onsubmit = null; // Clear submit handler
    }

    // Custom Confirmation Dialog (replaces browser's confirm)
    function showConfirmDialog(message, onConfirm) {
        const confirmModalHtml = `
            <div id="confirmModal" style="display:flex; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); justify-content: center; align-items: center;">
                <div style="background-color:#fefefe; padding:25px; border-radius:10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-width:400px; text-align:center;">
                    <p style="font-size:1.1em; margin-bottom:25px;">${message}</p>
                    <button id="confirmYesBtn" style="background:#f44336; margin-right:15px;">Yes</button>
                    <button id="confirmNoBtn" style="background:#6c757d;">No</button>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', confirmModalHtml);

        const confirmModal = document.getElementById('confirmModal');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        confirmYesBtn.onclick = () => {
            onConfirm();
            confirmModal.remove();
        };
        confirmNoBtn.onclick = () => {
            confirmModal.remove();
        };
    }


    // Open Update Engineer Modal
    function openUpdateEngineerModal(id, username, password) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can update engineer accounts.', 'error');
        return;
      }
      modalTitle.innerText = `Update Engineer (ID: ${id})`;
      modalForm.innerHTML = `
        <div class="form-group">
          <label for="modalUsername">Username:</label>
          <input type="text" id="modalUsername" value="${username}" required />
        </div>
        <div class="form-group">
          <label for="modalPassword">Password:</label>
          <input type="password" id="modalPassword" value="${password}" required />
        </div>
      `;
      modalForm.onsubmit = async function(e) {
        e.preventDefault();
        const updatedUsername = document.getElementById('modalUsername').value;
        const updatedPassword = document.getElementById('modalPassword').value;
        try {
          const res = await fetch(`${API_BASE_URL}/engineers/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Role': currentRole,
              'X-Username': currentUser
            },
            body: JSON.stringify({ id, username: updatedUsername, password: updatedPassword, role: 'ENGINEER' })
          });
          if (res.ok) {
            showMessage('Engineer updated successfully!', 'success');
            loadEngineers();
            closeModal();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to update engineer.', 'error');
          }
        } catch (error) {
          console.error('Error updating engineer:', error);
          showMessage('Network error or server is unreachable. Failed to update engineer.', 'error');
        }
      };
      genericModal.style.display = 'flex'; // Use flex to center the modal
    }

    // Open Update Customer Modal
    function openUpdateCustomerModal(id, username, password) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can update customer accounts.', 'error');
        return;
      }
      modalTitle.innerText = `Update Customer (ID: ${id})`;
      modalForm.innerHTML = `
        <div class="form-group">
          <label for="modalUsername">Username:</label>
          <input type="text" id="modalUsername" value="${username}" required />
        </div>
        <div class="form-group">
          <label for="modalPassword">Password:</label>
          <input type="password" id="modalPassword" value="${password}" required />
        </div>
      `;
      modalForm.onsubmit = async function(e) {
        e.preventDefault();
        const updatedUsername = document.getElementById('modalUsername').value;
        const updatedPassword = document.getElementById('modalPassword').value;
        try {
          const res = await fetch(`${API_BASE_URL}/customers/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, username: updatedUsername, password: updatedPassword, role: 'CUSTOMER' })
          });
          if (res.ok) {
            showMessage('Customer updated successfully!', 'success');
            loadCustomers();
            closeModal();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to update customer.', 'error');
          }
        } catch (error) {
          console.error('Error updating customer:', error);
          showMessage('Network error or server is unreachable. Failed to update customer.', 'error');
        }
      };
      genericModal.style.display = 'flex'; // Use flex to center the modal
    }

    // Open Update Ticket Modal
    async function openUpdateTicketModal(id, description, status, acknowledgedById) {
      if (currentRole !== 'ENGINEER') {
        showMessage('Only engineers can update tickets.', 'error');
        return;
      }

      modalTitle.innerText = `Update Ticket (ID: ${id})`;
      
      // Fetch engineers to populate the dropdown for acknowledgedBy
      let engineersOptions = '<option value="">None</option>';
      try {
        const resEngineers = await fetch(`${API_BASE_URL}/engineers`);
        const engineersData = await resEngineers.json();
        engineersOptions += engineersData.map(e => 
          `<option value="${e.id}" ${e.id === acknowledgedById ? 'selected' : ''}>${e.username}</option>`
        ).join('');
      } catch (error) {
        console.error('Error fetching engineers for ticket update modal:', error);
        showMessage('Could not load engineers for ticket update.', 'error');
      }

      // Populate status options
      const ticketStatuses = ['CREATED', 'ACKNOWLEDGED', 'IN_PROGRESS', 'CLOSED'];
      let statusOptions = ticketStatuses.map(s => 
        `<option value="${s}" ${s === status ? 'selected' : ''}>${s.replace('_', ' ')}</option>`
      ).join('');

      modalForm.innerHTML = `
        <div class="form-group">
          <label for="modalDescription">Description:</label>
          <textarea id="modalDescription" required>${description}</textarea>
        </div>
        <div class="form-group">
          <label for="modalStatus">Status:</label>
          <select id="modalStatus">${statusOptions}</select>
        </div>
        <div class="form-group">
          <label for="modalAcknowledgedBy">Assigned Engineer:</label>
          <select id="modalAcknowledgedBy">${engineersOptions}</select>
        </div>
      `;
      modalForm.onsubmit = async function(e) {
        e.preventDefault();
        const updatedDescription = document.getElementById('modalDescription').value;
        const updatedStatus = document.getElementById('modalStatus').value;
        const updatedAcknowledgedById = document.getElementById('modalAcknowledgedBy').value;

        // Construct the ticket object for the PUT request
        const updatedTicket = {
            id: id,
            description: updatedDescription,
            status: updatedStatus,
            // acknowledgedBy needs to be an Engineer object, not just ID
            // We'll send the ID and let the backend handle fetching the Engineer object
            acknowledgedBy: updatedAcknowledgedById ? { id: parseInt(updatedAcknowledgedById) } : null
        };

        try {
          const res = await fetch(`${API_BASE_URL}/tickets/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'X-User-Role': currentRole,
              'X-Username': currentUser
            },
            body: JSON.stringify(updatedTicket)
          });
          if (res.ok) {
            showMessage('Ticket updated successfully!', 'success');
            loadTickets();
            closeModal();
          } else {
            const errorData = await res.json();
            showMessage(errorData.error || 'Failed to update ticket.', 'error');
          }
        } catch (error) {
          console.error('Error updating ticket:', error);
          showMessage('Network error or server is unreachable. Failed to update ticket.', 'error');
        }
      };
      genericModal.style.display = 'flex'; // Use flex to center the modal
    }

    // Initial check (optional, but good for refresh scenarios)
    // If you want to persist login, you'd use localStorage here.
    // For this example, we assume fresh login on page load.
    // showTab('tickets'); // Default to tickets tab on load
  </script>
</body>
</html>
